<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>◈ N3USYS Lattice Alive Prototype ◈</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  display:flex;
  height:100vh;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#f0f5f8;
  color:#222;
  overflow:hidden;
}

/* Side panels */
#left-console, #right-monitor {
  width:350px;
  padding:20px;
  overflow-y:auto;
  background:#fff;
  border:2px solid #0ff;
  box-shadow:0 0 20px rgba(0,188,212,0.3);
  position:relative;
  z-index:10;
  transition:0.3s;
}
#left-console { border-right:2px solid #0ff; }
#right-monitor { border-left:2px solid #0ff; }

h2 { text-align:center; color:#00bcd4; margin-bottom:15px; }
h3 { color:#00bcd4; margin:20px 0 10px 0; }

textarea {
  width:100%; height:100px; padding:10px;
  font-size:14px;
  border:2px solid #0ff;
  background:#f0faff;
  color:#022;
  resize:none;
}

button {
  width:100%; margin:8px 0; padding:12px;
  border:1px solid #0ff;
  background:#fff;
  color:#00bcd4;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
}
button:hover {
  box-shadow:0 0 15px #0ff;
  color:#fff;
  background:#00bcd4;
}

#isolated-list div {
  margin:5px 0; padding:8px;
  border-left:4px solid #0ff;
  background:rgba(0,188,212,0.1);
  border-radius:4px;
}

/* Lattice container */
#lattice-container {
  flex:1;
  margin:20px 10px;
  border:2px solid #0ff;
  box-shadow:0 0 40px rgba(0,188,212,0.3);
  background:#e5f8fc;
  position:relative;
  display:flex;
  flex-direction:column;
}

#lattice {
  flex:1;
  width:100%;
  height:100%;
}

#lattice-info {
  padding:8px;
  border-top:2px solid #0ff;
  font-size:14px;
  color:#222;
  background:#f0faff;
  text-align:center;
}

#resonance-chart {
  width:100%; height:180px;
  border:1px solid #0ff;
  background:#f0faff;
  margin-top:10px;
}

#current-resonance {
  text-align:center;
  font-size:20px;
  margin-top:6px;
  color:#00bcd4;
}
</style>
</head>
<body>

<div id="left-console">
  <h2>Operator Console</h2>
  <button onclick="toggleAnimation()">Pause / Resume</button>
  <button onclick="snapshot()">Snapshot (PNG)</button>
  <button onclick="exportIsolationLog()">Export Isolated (JSON)</button>

  <h3>Intent Injection</h3>
  <textarea id="intent-text" placeholder="chaos reigns • order within chaos • lotus equilibrium • crystalline stasis"></textarea>
  <button onclick="injectIntent()">Inject Intent</button>

  <h3>Isolated Nodes</h3>
  <div id="isolated-list">Click nodes to isolate</div>
</div>

<div id="lattice-container">
  <svg id="lattice"></svg>
  <div id="lattice-info">This visualization represents the N3USYS lattice. Nodes pulse and respond dynamically to injected intent, while the center node represents the operator core.</div>
</div>

<div id="right-monitor">
  <h2>Resonance Monitor</h2>
  <svg id="resonance-chart"></svg>
  <div id="current-resonance">20.0%</div>
</div>

<script>
const container = document.getElementById("lattice-container");
let width = container.clientWidth;
let height = container.clientHeight;
const svg = d3.select("#lattice").attr("width", width).attr("height", height);

let isRunning = true;
let globalResonance = 20;
let resonanceHistory = [];
const maxHistory = 400;
let startTime = Date.now();

// Nodes and Links
const nodes = [{id:"operator", title:"N3USYS Core", fx: width/2, fy: height/2}];
for(let i=1;i<=140;i++) nodes.push({id:"n"+i, phase:Math.random()*Math.PI*2});

const links = [];
nodes.forEach(d=>{ if(d.id!=="operator") links.push({source:"operator", target:d.id}); });
for(let i=1;i<120;i+=8) links.push({source:nodes[i].id, target:nodes[(i+21)%140 +1].id});

// Force simulation
const simulation = d3.forceSimulation(nodes)
  .force("link", d3.forceLink(links).id(d=>d.id).distance(80).strength(0.6))
  .force("charge", d3.forceManyBody().strength(-200))
  .force("center", d3.forceCenter(width/2, height/2))
  .force("collision", d3.forceCollide().radius(d=>d.id==="operator"?40:12));

const linkG = svg.append("g").selectAll("line").data(links).enter().append("line")
  .attr("stroke","#00bcd4").attr("stroke-width",1.5).attr("stroke-opacity",0.5);

const nodeG = svg.append("g").selectAll("g").data(nodes).enter().append("g");

nodeG.append("circle")
  .attr("r", d=>d.id==="operator"?38:9)
  .attr("fill", d=>d.id==="operator"? "#ff4081":"#00bcd4")
  .attr("stroke","#00bcd4")
  .attr("stroke-width",3)
  .style("cursor","pointer")
  .on("mouseover", function(){ d3.select(this).attr("stroke-width",6); })
  .on("mouseout", function(){ d3.select(this).attr("stroke-width",3); })
  .on("click", function(event,d){
    event.stopPropagation();
    const idx = N3USYS_ISOLATED.findIndex(n=>n.id===d.id);
    if(idx===-1){ N3USYS_ISOLATED.push(d); d3.select(this).attr("stroke","#ff0"); }
    else { N3USYS_ISOLATED.splice(idx,1); d3.select(this).attr("stroke","#00bcd4"); }
    updateIsolationPanel();
  });

nodeG.append("text")
  .text(d=>d.id==="operator"?"◈":"")
  .attr("fill","#222")
  .attr("font-size",40)
  .attr("text-anchor","middle")
  .attr("dy",15)
  .style("pointer-events","none");

// Resonance chart
const chartSvg = d3.select("#resonance-chart").attr("viewBox","0 0 340 180");
const xScale = d3.scaleLinear().domain([0,maxHistory-1]).range([40,300]);
const yScale = d3.scaleLinear().domain([0,100]).range([160,20]);
chartSvg.append("g").attr("transform","translate(0,160)").call(d3.axisBottom(xScale).ticks(5));
chartSvg.append("g").attr("transform","translate(40,0)").call(d3.axisLeft(yScale));
const line = chartSvg.append("path").attr("fill","none").attr("stroke","#00bcd4").attr("stroke-width",2);

function updateChart(){
  resonanceHistory.push(globalResonance);
  if(resonanceHistory.length>maxHistory) resonanceHistory.shift();
  const data = resonanceHistory.map((d,i)=>({x:i,y:d}));
  line.attr("d", d3.line().x(d=>xScale(d.x)).y(d=>yScale(d.y))(data));
  document.getElementById("current-resonance").textContent = globalResonance.toFixed(1)+"%";
}

window.N3USYS_ISOLATED=[];

function toggleAnimation(){ isRunning=!isRunning; }
function snapshot(){ /* same snapshot logic as before */ }
function injectIntent(){
  const text=document.getElementById("intent-text").value.trim()||"breathe";
  const hash=text.split("").reduce((a,c)=>a+c.charCodeAt(0),0);
  const chaos=(hash%100)/100;
  globalResonance=20+chaos*40;
  document.getElementById("intent-text").value="";
}
function updateIsolationPanel(){
  document.getElementById("isolated-list").innerHTML=N3USYS_ISOLATED.map(n=>
    `<div><strong>${n.title||n.id}</strong> X:${n.x.toFixed(0)} Y:${n.y.toFixed(0)}</div>`
  ).join("")||"Click nodes to isolate...";
}

// Separate animation for breathing
function animate(){
  if(!isRunning){ requestAnimationFrame(animate); return; }
  const t = (Date.now()-startTime)/1000;
  nodeG.selectAll("circle").attr("r", d=>{
    const base = d.id==="operator"?38:9;
    const pulse = d.id==="operator"? Math.sin(t*2)*6 : Math.sin(t*1.5 + d.phase)*3;
    return base + pulse;
  });

  linkG
    .attr("x1",d=>d.source.x)
    .attr("y1",d=>d.source.y)
    .attr("x2",d=>d.target.x)
    .attr("y2",d=>d.target.y)
    .attr("stroke-opacity",0.3+globalResonance/120)
    .attr("stroke-width",1+globalResonance/50);

  nodeG.attr("transform", d=>`translate(${d.x},${d.y})`);
  updateChart();
  requestAnimationFrame(animate);
}
animate();

window.addEventListener("resize",()=>{
  width=container.clientWidth;
  height=container.clientHeight;
  simulation.force("center", d3.forceCenter(width/2,height/2)).alpha(0.3).restart();
});
console.log("%c◈ N3USYS Lattice Alive Prototype Active ◈","color:#00bcd4;font-size:18px;font-weight:bold;");
</script>
</body>
</html>
